---
title: "Get cohort patients characteristics"
author: "Marti Catala, Mike Du, Yuchen Guo and Kim Lopez-Guell"
date: "`r Sys.Date()`"
output: 
  html_document:
    pandoc_args: [
      "--number-offset=1,0"
      ]
    number_sections: yes
    toc: yes
vignette: >
  %\VignetteIndexEntry{Get cohort patients characteristics}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Introduction

In this vignette we show several different functions to get characteristics (e.g. age, sex, prior history...) of a cohort in a database mapped to OMOP CDM. This can be useful when doing explanatory analysis as well as calling these functions for more complex analyses.

First, we would connect to our OMOP CDM database using the packages DBI and CDMConnector as follows.

```{r, eval=FALSE}
library(DBI)
library(CDMConnector)

# The input arguments provided are for illustrative purposes only and do not provide access to any database.

con <- DBI::dbConnect(RPostgres::Postgres(),
                      dbname = "omop_cdm",          
                      host = "10.80.192.00",
                      user = "user_name",
                      password = "user_pasword"
             )

cdm <- CDMConnector::cdm_from_con(con,
                                  cdm_schema = "main",
                                  write_schema = "main",
                                  cohort_tables = "cohort_example"
                      )
```

The example uses a simulated dataset generated by the `mockPatientProfiles()` function provided in this package, which mimics a database formatted in OMOP:

```{r, message= FALSE, warning=FALSE}
library(PatientProfiles)
library(duckdb)
library(tibble)
library(dplyr)

# Mock person table in OMOP CDM format
person <- tibble(person_id = c("1", "2", "3"),
                 gender_concept_id = c("8507", "8532", "8507"),
                 year_of_birth = c(1980, 1990, 2000),
                 month_of_birth = c(NA, 07, 08),
                 day_of_birth = c(NA, NA, 03))

# Mock observation period table in OMOP CDM format
observation_period <- tibble(person_id = c("1", "2", "3"),
                            observation_period_start_date = c(
                              as.Date("2006-01-01"), as.Date("2006-01-01"), as.Date("2007-04-03")),
                            observation_period_end_date = c(
                              as.Date("2022-01-01"), as.Date("2019-11-01"), as.Date("2022-01-01")))

# Mock permanent cohort table in OMOP CDM format
cohort1 <- tibble(cohort_definition_id = 1,
                  subject_id = c("1", "2", "3"),
                  cohort_start_date = c(
                    as.Date("2010-01-01"), as.Date("2010-01-01"), as.Date("2010-01-01")),
                  cohort_end_date = c(
                    as.Date("2015-01-01"), as.Date("2013-01-01"), as.Date("2018-01-01")))

cdm <- mockPatientProfiles(person = person, 
                           observation_period = observation_period, 
                           cohort_example = cohort1)
```

## Example: addAge function

`addAge()`: adds a new column to the input cohort table, containing each patient's age at `indexDate` which must be a column of the input table (defaulted to "cohort_start_date"). The function requires a `cdm` reference to calculate the age of the subjects. 
For patients with missing month and/or day of birth, the default value of 1st January is used. However, the user can set different default values using the `defaultMonth` and `defaultDay` arguments. The function also allows the user to specify whether the same default month and/or day should be used for all subjects, using the logical variables `imposeMonth` and `imposeMonth`. By default, these variables are set to TRUE.
The function can classify patient's into different age groups based on the argument `ageGroup`, which is null by default.  If the user provides a list of desired age classifications, the function will append new columns with the corresponding age group classifications to the input table.

Suppose we want to calculate the age of patients on the day they enter the cohort and categorize them into 20-year age bands as well as identify those 30 years old or more. Further, day and month of birth will be 1st of June for everyone.
The function `addAge()` can be used as follows:

```{r, message= FALSE, warning=FALSE}
cdm$cohort_example <- cdm$cohort_example %>%
  addAge(
    cdm = cdm,
    ageDefaultMonth = 1,
    ageDefaultDay = 6,
    ageGroup = list("age_group" = list("0 to 19"  = c(0, 19), 
                                       "20 to 39" = c(20, 39), 
                                       "40 to 59" = c(40, 59), 
                                       "60 to 79" = c(60, 79), 
                                       "80 to 99" = c(80, 99),
                                       ">= 100"   = c(100, 150)))
  )

```
## Example: addSex function

`addSex()`: appends a column to the input table indicating the sex for each patient as "Female" or "Male". The default name for the new column is "sex", and can be changed with the input argument `name`. The input table requires to be in `cdm` reference to get the sex of the subjects.

We can add the patient's sex to the previous cohort table, and then use this information to filter by age and sex:

```{r, message= FALSE, warning=FALSE}
cdm$cohort_example <- cdm$cohort_example %>%
  addSex(
    cdm = cdm
  )

male20to39_subset <- cdm$cohort_example %>%
  filter(sex == "Male") %>%
  filter(age_group == "20 to 39") 
```

## Example: addInObservation, addPriorHistory and addFutureObservation functions

`addInObservation()`: adds a new binary column to the input table, indicating whether the subjects are being observed at a specific time. By default, the time is set to "cohort_start_date," but it can be changed with the `index_date` argument, which should refer to a column in the table. The added column is named "in_observation" by default, but this can be customized using the `name` argument.

`addPriorHistory()`: appends a column to the input table containing the number of days each patient has been in observation up to a specified date. By default, the function uses the "cohort_start_date" column as the date of interest, but the user can specify any other date column using the `indexDate` argument. The newly created column has the name "prior_history" unless the user specifies a different name with the argument `name`.

`addFutureObservation()`: adds a column with the days of future observation for an individual at `indexDate` (defaulted to "cohort_start_date"). The new column is named "future_observation" if otherwise not stated in the `name` argument.

If the database allows for multiple observation periods, it's important to note that the results of the previous functions will be based on the period where `indexDate` falls within. If a patient is not under observation at the specified `indexDate`, the `addPriorHistory()` and `addFutureObservation()` functions will return NA.


We can use the first function to get patients which are in observation and then get their prior and future observation days at "cohort_start_date".

```{r, message= FALSE, warning=FALSE}
cdm$cohort_example <- cdm$cohort_example %>%
  addInObservation(
    cdm = cdm 
  ) %>%
  filter(
    in_observation == 1
  ) %>%
  addPriorHistory(
    cdm = cdm
  ) %>%
  addFutureObservation(
    cdm = cdm
  )
```


YThe function `addDemographics()` can be used to add all the features presented in this vignette (except for `addInObservation()`) at once. In fact, the functions presented here internally call `addDemographics()` to compute their outputs. Therefore, any error messages related to the output of individual functions will mention the `addDemographics()` function. To learn more about this function, refer to the vignette titled "Get Table Patients Characteristics".

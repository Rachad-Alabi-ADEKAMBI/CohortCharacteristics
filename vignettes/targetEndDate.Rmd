---
title: "targetEndDate functionality"
author: "Martí Català, Mike Du, Yuchen Guo, Kim López-Güell, Xintong Li, Núria Mercadé-Besora, and Edward Burn"
date: "`r Sys.Date()`"
output: 
  html_document:
    pandoc_args: [
      "--number-offset=1,0"
      ]
    number_sections: yes
    toc: yes
vignette: >
  %\VignetteIndexEntry{targetEndDate functionality}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Introduction

In this vignette we introduce the `targetEndDate` functionality found in `countCohortOccurrences()` and `flagCohortPresence()` functions. In both of them, there are three reference dates which can be specified:
* `indexDate`: date from the primary cohort table, which contains the individuals for which we want to find the intersection events
* `targetStartDate`: date from the events table used for the intersection
* `targetEndDate`: date from the events table used for the intersection

```{r, message=FALSE}
library(dplyr)
library(PatientProfiles)
```

## Example: overlapping events

By default, `indexDate = cohort_start_date`, `targetStartDate = cohort_start_date` and `targetEndDate = cohort_end_date`. This means that, if we are intersecting two cohorts and specify `window = c(-30,-1)`, we will get any events from the intersecting cohort happening up to 30 days previous to the cohort start date of the main cohort. Namely:

```{r}

# This will be our "main" cohort
  cohort1 <- tibble::tibble(
    cohort_definition_id = 1,
    subject_id = c("1", "2"),
    cohort_start_date = c(
      as.Date("2010-03-01"),
      as.Date("2012-03-01")
    ),
    cohort_end_date = c(
      as.Date("2015-01-01"),
      as.Date("2016-03-01")
    )
  )

# This is the cohort with the events we are interested in
  cohort2 <- tibble::tibble(
    cohort_definition_id = 1,
    subject_id = c("1", "1", "1", "2"),
    cohort_start_date = c(
      as.Date("2010-03-03"),
      as.Date("2010-02-27"),
      as.Date("2010-01-25"),
      as.Date("2013-01-03")
    ),
    cohort_end_date = c(
      as.Date("2010-03-03"),
      as.Date("2010-02-27"),
      as.Date("2012-03-25"),
      as.Date("2013-01-03")
    )
  )

  cdm <- mockPatientProfiles(
    cohort1 = cohort1,
    cohort2 = cohort2
  )
  
  cdm$cohort1 <- cdm$cohort1 %>% countCohortOccurrences(cdm, targetCohortTable = "cohort2", window = list(c(-30,-1)))
  cdm$cohort1

```

We get two events for `subject_id = 1`, the one starting and ending on the `2010-02-27`, which is within the window before the index date `2010-03-01`; and the one starting in `2010-01-25` and ending on `2012-03-25`. The individual `subject_id = 2` does not have any of the intersecting events of interest. 

## Example: incident events

Note that, with the specifications by default, we pick one event (the second one), which is not incident in the window of interest, but overlaps it. Indeed, as the event start date is before the index date in the main cohort and the end date is after it, it is regarded as intersecting.

However, we could be interested in events starting in the window of interest. To only screen for those, we can set `targetEndDate = cohort_start_date`.


```{r, message= FALSE, warning=FALSE}
  cdm$cohort1 <- cdm$cohort1 %>% countCohortOccurrences(cdm, targetCohortTable = "cohort2", window = list(c(-30,-1)), targetEndDate = "cohort_start_date")
  cdm$cohort1
                          
```

Now we do not pick the event which starts on `2010-01-25`, which is more than 30 days before the index date of the main cohort, `2010-03-01`. 

The input `targetEndDate` allows, therefore, to select whether to perform the intersection in an "overlapping" or "incident" way.

As for the functions `timeToCohort()` and `dateOfCohort()`, they need a specific date in the target cohort to calculate time outputs. Therefore, only `targetDate` needs to be specified, which is set to "cohort_start_date" by default.


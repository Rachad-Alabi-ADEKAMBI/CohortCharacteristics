---
title: "Get cohort intersections"
author: "Martí Català, Mike Du, Yuchen Guo, Kim Lopez-Guell, Xintong Li, Núria Mercadé-Besora, and Edward Burn"
date: "`r Sys.Date()`"
output: 
  html_document:
    pandoc_args: [
      "--number-offset=1,0"
      ]
    number_sections: yes
    toc: yes
vignette: >
  %\VignetteIndexEntry{Get cohort patients characteristics}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Introduction

In this vignette we present how function from this package can be used to get intersecctions between cohorts. This can be useful, for instance, if we want to identify patients with previous conditions. 

The PatientProfiles package is designed to work with data in the OMOP CDM format, so our first step is to create a reference to the data using the DBI and CDMConnector packages. The connection to a Postgres database would look like:

```{r, eval=FALSE}
library(DBI)
library(CDMConnector)

# The input arguments provided are for illustrative purposes only and do not provide access to any database.

con <- DBI::dbConnect(RPostgres::Postgres(),
                      dbname = "omop_cdm",          
                      host = "10.80.192.00",
                      user = "user_name",
                      password = "user_pasword"
)

cdm <- CDMConnector::cdm_from_con(con,
                                  cdm_schema = "main",
                                  write_schema = "main",
                                  cohort_tables = "cohort_example"
)
```

In this vignette we will work with simulated data generated by the `mockPatientProfiles()` function provided in this package, which mimics a database formatted in OMOP. 

```{r, message= FALSE, warning=FALSE}
library(PatientProfiles)
library(duckdb)
library(tibble)
library(dplyr)

cdm <- mockPatientProfiles(
  patient_size = 1000, 
  drug_exposure_size = 1000
)
                          
```

In this mock dataset there are the following cohort tables:
```{r, message= FALSE, warning=FALSE}
cdm$cohort1 %>%
  glimpse()

cdm$cohort2 %>%
  glimpse()                       
```
## Example: flag.. and count.. functions
`flag...()`

Suppose cohort2 contains stroke occurrences., and we want to exclude patients from cohort1 who had a stroke outcome in the last 180 days before their index date. To accomplish this, we can use the `flag..()`:

```{r, message= FALSE, warning=FALSE}
# cdm$cohort1 <- cdm$cohort1 %>%
#   flag...() %>%
#   filter() ...
# 
# cdm$cohort1 %>%
#   glimpse()
```


`count...()`

This function can be useful for counting stroke occurrences in patients within specific time frames before the index date. For example, we could count the number of occurrences in the 0-30 day, 30-180 day, and all prior history time windows.
We would use the function like this

```{r, message= FALSE, warning=FALSE}
# cdm$cohort1 <- cdm$cohort1 %>%
#   flag...() %>%
#   filter() ...
# 
# cdm$cohort1 %>%
#   glimpse()
```


## Example: date... function


## Example: time... function




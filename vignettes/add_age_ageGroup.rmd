---
title: "Get characterics using PatientProfiles"
author: "Marti Catala, Mike Du, Yuchen Guo and Kim Lopez-Guell"
date: "`r Sys.Date()`"
output: 
  html_document:
    pandoc_args: [
      "--number-offset=1,0"
      ]
    number_sections: yes
    toc: yes
vignette: >
  %\VignetteIndexEntry{Get characterics using PatientProfiles}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo = FALSE, message = FALSE, warning = FALSE}
# library(PatientProfiles)
```

## Introduction

In this vignette we show several different functions to get characteristics like age, sex, prior history.. This can be useful when doing explanatory analysis as well as calling these functions for more complex analyses.


## addAge and addAgeGroup function

`addAge` function adds age as a column to your cohort table. You can choose how to impute missing month and day of birth by changing defaultMonth and defaultDay. Or you can use imposeMonth/imposeDay, then all month/day of birth will be considered as missing and will be imputed.

First, relevant libraries and mock data are created for demonstration. This package uses data mapped to the OMOP CDM, which can be accessed using CDMConnector package as follows:

```{r, eval=FALSE}
library(DBI)
library(CDMConnector)
library(PatientProfiles)
con <- DBI::dbConnect(RPostgres::Postgres(),
                      dbname = "omop_cdm",
                      host = "10.80.192.00",
                      user = "user_name",
                      password = "user_pasword")
cdm <- CDMConnector::cdm_from_con(con,
                                  cdm_schema = "main",
                                  write_schema = "main",
                                  cohort_tables = "cohort_example")
```


This example uses mock data generated using the `mockPatientProfiles()` function included in this package:
```{r, message= FALSE, warning=FALSE}
library(DBI)
library(duckdb)
library(tibble)
library(PatientProfiles)
cohort1 <- tibble::tibble(
  cohort_definition_id = 1,
  subject_id = c("1", "2", "3"),
  cohort_start_date = c(
    as.Date("2010-01-01"), as.Date("2010-01-01"), as.Date("2010-01-01")
  ),
  cohort_end_date = c(
    as.Date("2015-01-01"), as.Date("2013-01-01"), as.Date("2018-01-01")
  )
)
person <- tibble::tibble(
  person_id = c("1", "2", "3"),
  gender_concept_id = c("8507", "8532", "8507"),
  year_of_birth = c(1980, 1990, 2000),
  month_of_birth = c(NA, 07, 08),
  day_of_birth = c(01, 25, 03)
)

observation_period <- tibble::tibble(
  person_id = c("1", "2", "3"),
  observation_period_start_date = c(as.Date("2006-01-01"), as.Date("2006-01-01"), as.Date("2007-04-03")),
  observation_period_end_date = c(as.Date("2022-01-01"), as.Date("2019-11-01"), as.Date("2022-01-01"))
)

cdm <- mockPatientProfiles(person = person, 
                           observation_period = observation_period, 
                           cohort_example = cohort1)
```


Once we have the `cdm` object we can use the function `addAge()`, to add the age column to the table `cohort_example`.
```{r, message= FALSE, warning=FALSE}
cdm$cohort_example <- cdm$cohort_example %>%
  addAge(
    cdm = cdm, 
    defaultMonth = 12, 
    defaultDay = 3
  )
```


After getting age for your cohort, `addAgeGroup` function can be used to add a column that will classify cohort subjects within age groups. Groups are defined in the argument `ageGroup` as a list of vectors (as seen below). If the user do no provides names for the age groups, the default setting of the function will combine the `ageGroup` provided.

In the case where `x` has no age column, age will automatically be computed by `addAge` function. Therefore, `x` needs to be in cdm to get the age computed. Output of `addAgeGroup` will be the same table as previous addAge example with one extra column: `ageGroupNames`.

```{r, message= FALSE, warning=FALSE}
cdm$cohort_example <- cdm$cohort_example %>% 
  addAgeGroup(
    ageGroup = list(c(0, 19), c(20, 49), c(50, 79), c(80, 99), c(100, 150)),
    cdm = cdm
    )
```

## addSex function

The function `addSex` can be used to append a column to the input table indicating the sex for each patient as "Female" or "Male". The default name for the new column is `sex`, and can be changed with the input argument `name`. The table `x` requires to be in `cdm` reference to get the sex of the subjects.

The resulting output of the code below will be the input table `x` with an added column identifying the sex of each patient. This additional column will be refered to as `sex` since no column name is specified.
```{r, message= FALSE, warning=FALSE}
cdm$cohort_example <- cdm$cohort_example %>%
  addSex(
    cdm = cdm
  )
```


## addFollowUp and addPriorHistory functions

`addFollowUp` computes the number of days of follow-up for each subject. As optional input arguments, the user can provide the names of the columns containing the start and end dates of patient's follow up. Otherwise, the deafult columns are `cohort_start_date` and `cohort_end_date` respectively.

For this function, the table does not need to be in `cdm` reference.

```{r, message= FALSE, warning=FALSE}
cdm$cohort1 %>% addAge(cdm = cdm, ageDefaultMonth = 12, ageDefaultDay = 3)
```

Similar to the previous functions, `addPriorHistory` appends a column to the input table. In this case, the added column contains the number of days a patient has been in observation at a certain date. The date should be a field of the input table, which is defaulted as `cohort_start_date`, but can be specified to any other date column in the table. The column created has the name `prior_history`.

Here, we calculate previous history at the time patients leaves the cohort:
```{r, message= FALSE, warning=FALSE}
cdm$cohort1 %>% 
  addAge(cdm = cdm, ageGroup = list(c(0, 29), c(30, 59), c(60, 150)))
```
Also can be computed using addCategories
```{r, message=FALSE, warning=FALSE}
cdm$cohort1 %>%
  addAge(cdm) %>%
  addCategories(cdm = cdm,
    variable = "age",
    categories = list("age_group" = list(c(0, 29), c(30, 59), c(60, 150)))
  )
```
